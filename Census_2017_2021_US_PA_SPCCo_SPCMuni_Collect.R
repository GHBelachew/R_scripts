# This is to excerise  censu API
# Census API 
# Southwestern Pennsylvania Commission

# ------------------------------------------------------------------------------
# ----- I. Setup ---------------------------------------------------------------
# Install  and load needed package 
#install.packages("tidycensus")
library(tidycensus)
library(tidyverse)
library(sf)


library(reshape2)
library(reshape)

census_api_key("xxx", install = FALSE)

# you tube source ; https://www.youtube.com/watch?v=kNCAlNqp4UQ

#----------II.  Get Data -------------------------------------------------------
# get_acs()
# get_decennial()
# get_estimates()
# get_pums()

# Get the variables for the census

v21 <- load_variables(2021, "acs5")
unique(v21$geography)

# get the tract level of ,  total population and Hispanic population
# here geography can be; State, county, tract, block group for ACS5

#==============================================================
#1. United States

# Define variables

all_var <- c("B04006_001E",
             "B04006_002E",
             "B04006_003E",
             "B04006_004E",
             "B04006_005E",
             "B04006_006E",
             "B04006_016E",
             "B04006_017E",
             "B04006_018E",
             "B04006_019E",
             "B04006_020E",
             "B04006_021E",
             "B04006_022E",
             "B04006_023E",
             "B04006_024E",
             "B04006_025E",
             "B04006_026E",
             "B04006_027E",
             "B04006_028E",
             "B04006_029E",
             "B04006_030E",
             "B04006_031E",
             "B04006_032E",
             "B04006_033E",
             "B04006_034E",
             "B04006_035E",
             "B04006_036E",
             "B04006_037E",
             "B04006_038E",
             "B04006_039E",
             "B04006_040E",
             "B04006_041E",
             "B04006_042E",
             "B04006_043E",
             "B04006_044E",
             "B04006_045E",
             "B04006_046E",
             "B04006_047E",
             "B04006_048E",
             "B04006_049E",
             "B04006_050E",
             "B04006_051E",
             "B04006_052E",
             "B04006_053E",
             "B04006_054E",
             "B04006_055E",
             "B04006_056E",
             "B04006_057E",
             "B04006_058E",
             "B04006_059E",
             "B04006_060E",
             "B04006_061E",
             "B04006_062E",
             "B04006_063E",
             "B04006_064E",
             "B04006_065E",
             "B04006_066E",
             "B04006_067E",
             "B04006_068E",
             "B04006_069E",
             "B04006_070E",
             "B04006_071E",
             "B04006_072E",
             "B04006_073E",
             "B04006_089E",
             "B04006_090E",
             "B04006_091E",
             "B04006_092E",
             "B04006_093E",
             "B04006_094E",
             "B04006_107E",
             "B04006_108E",
             "B04006_109E",
             "B05002_001E",
             "B05002_002E",
             "B05002_003E",
             "B05002_004E",
             "B05002_009E",
             "B05002_013E",
             "B05002_014E",
             "B05002_021E",
             "B05006_001E",
             "B05006_002E",
             "B05006_047E",
             "B05006_091E",
             "B05006_122E",
             "B05006_130E",
             "B05006_166E",
             "B07403_001E",
             "B07403_004E",
             "B07403_007E",
             "B07403_010E",
             "B07403_013E",
             "B08006_001E",
             "B08006_003E",
             "B08006_004E",
             "B08006_008E",
             "B08006_014E",
             "B08006_015E",
             "B08006_016E",
             "B08006_017E",
             "B08013_001E",
             "B10051_001E",
             "B10051_002E",
             "B11001_001E",
             "B12001_001E",
             "B12001_003E",
             "B12001_004E",
             "B12001_007E",
             "B12001_009E",
             "B12001_010E",
             "B12001_012E",
             "B12001_013E",
             "B12001_016E",
             "B12001_018E",
             "B12001_019E",
             "B14001_002E",
             "B14001_003E",
             "B14001_004E",
             "B14001_005E",
             "B14001_006E",
             "B14001_007E",
             "B14001_008E",
             "B14001_009E",
             "B15002_001E",
             "B15002_003E",
             "B15002_004E",
             "B15002_005E",
             "B15002_006E",
             "B15002_007E",
             "B15002_008E",
             "B15002_009E",
             "B15002_010E",
             "B15002_011E",
             "B15002_012E",
             "B15002_013E",
             "B15002_014E",
             "B15002_015E",
             "B15002_016E",
             "B15002_017E",
             "B15002_018E",
             "B15002_020E",
             "B15002_021E",
             "B15002_022E",
             "B15002_023E",
             "B15002_024E",
             "B15002_025E",
             "B15002_026E",
             "B15002_027E",
             "B15002_028E",
             "B15002_029E",
             "B15002_030E",
             "B15002_031E",
             "B15002_032E",
             "B15002_033E",
             "B15002_034E",
             "B15002_035E",
             "B17001_004E",
             "B17001_005E",
             "B17001_006E",
             "B17001_007E",
             "B17001_008E",
             "B17001_009E",
             "B17001_010E",
             "B17001_011E",
             "B17001_012E",
             "B17001_013E",
             "B17001_014E",
             "B17001_015E",
             "B17001_016E",
             "B17001_018E",
             "B17001_019E",
             "B17001_020E",
             "B17001_021E",
             "B17001_022E",
             "B17001_023E",
             "B17001_024E",
             "B17001_025E",
             "B17001_026E",
             "B17001_027E",
             "B17001_028E",
             "B17001_029E",
             "B17001_030E",
             "B17001_033E",
             "B17001_034E",
             "B17001_035E",
             "B17001_036E",
             "B17001_037E",
             "B17001_038E",
             "B17001_039E",
             "B17001_040E",
             "B17001_041E",
             "B17001_042E",
             "B17001_043E",
             "B17001_044E",
             "B17001_045E",
             "B17001_047E",
             "B17001_048E",
             "B17001_049E",
             "B17001_050E",
             "B17001_051E",
             "B17001_052E",
             "B17001_053E",
             "B17001_054E",
             "B17001_055E",
             "B17001_056E",
             "B17001_057E",
             "B17001_058E",
             "B17001_059E",
             "B17012_003E",
             "B17012_009E",
             "B17012_014E",
             "B17012_020E",
             "B17012_026E",
             "B17012_031E",
             "B18101_003E",
             "B18101_004E",
             "B18101_006E",
             "B18101_007E",
             "B18101_009E",
             "B18101_010E",
             "B18101_012E",
             "B18101_013E",
             "B18101_015E",
             "B18101_016E",
             "B18101_018E",
             "B18101_019E",
             "B18101_022E",
             "B18101_023E",
             "B18101_025E",
             "B18101_026E",
             "B18101_028E",
             "B18101_029E",
             "B18101_031E",
             "B18101_032E",
             "B18101_034E",
             "B18101_035E",
             "B18101_037E",
             "B18101_038E",
             "B18102_004E",
             "B18102_007E",
             "B18102_010E",
             "B18102_013E",
             "B18102_016E",
             "B18102_019E",
             "B18102_023E",
             "B18102_026E",
             "B18102_029E",
             "B18102_032E",
             "B18102_035E",
             "B18102_038E",
             "B18103_004E",
             "B18103_007E",
             "B18103_010E",
             "B18103_013E",
             "B18103_016E",
             "B18103_019E",
             "B18103_023E",
             "B18103_026E",
             "B18103_029E",
             "B18103_032E",
             "B18103_035E",
             "B18103_038E",
             "B18104_004E",
             "B18104_007E",
             "B18104_010E",
             "B18104_013E",
             "B18104_016E",
             "B18104_020E",
             "B18104_023E",
             "B18104_026E",
             "B18104_029E",
             "B18104_032E",
             "B18105_004E",
             "B18105_007E",
             "B18105_010E",
             "B18105_013E",
             "B18105_016E",
             "B18105_020E",
             "B18105_023E",
             "B18105_026E",
             "B18105_029E",
             "B18105_032E",
             "B18106_004E",
             "B18106_007E",
             "B18106_010E",
             "B18106_013E",
             "B18106_016E",
             "B18106_020E",
             "B18106_023E",
             "B18106_026E",
             "B18106_029E",
             "B18106_032E",
             "B18107_004E",
             "B18107_007E",
             "B18107_010E",
             "B18107_013E",
             "B18107_017E",
             "B18107_020E",
             "B18107_023E",
             "B18107_026E",
             "B19001_001E",
             "B19001_002E",
             "B19001_003E",
             "B19001_004E",
             "B19001_005E",
             "B19001_006E",
             "B19001_007E",
             "B19001_008E",
             "B19001_009E",
             "B19001_010E",
             "B19001_011E",
             "B19001_012E",
             "B19001_013E",
             "B19001_014E",
             "B19001_015E",
             "B19001_016E",
             "B19001_017E",
             "B19013_001E",
             "B19051_002E",
             "B19055_002E",
             "B19056_002E",
             "B19057_002E",
             "B19059_002E",
             "B19061_001E",
             "B19065_001E",
             "B19066_001E",
             "B19067_001E",
             "B19069_001E",
             "B19101_001E",
             "B19101_002E",
             "B19101_003E",
             "B19101_004E",
             "B19101_005E",
             "B19101_006E",
             "B19101_007E",
             "B19101_008E",
             "B19101_009E",
             "B19101_010E",
             "B19101_011E",
             "B19101_012E",
             "B19101_013E",
             "B19101_014E",
             "B19101_015E",
             "B19101_016E",
             "B19101_017E",
             "B19113_001E",
             "B19301_001E",
             "B21001_001E",
             "B21001_002E",
             "B23001_002E",
             "B23001_004E",
             "B23001_005E",
             "B23001_007E",
             "B23001_011E",
             "B23001_012E",
             "B23001_014E",
             "B23001_018E",
             "B23001_019E",
             "B23001_021E",
             "B23001_025E",
             "B23001_026E",
             "B23001_028E",
             "B23001_032E",
             "B23001_033E",
             "B23001_035E",
             "B23001_039E",
             "B23001_040E",
             "B23001_042E",
             "B23001_046E",
             "B23001_047E",
             "B23001_049E",
             "B23001_053E",
             "B23001_054E",
             "B23001_056E",
             "B23001_060E",
             "B23001_061E",
             "B23001_063E",
             "B23001_067E",
             "B23001_068E",
             "B23001_070E",
             "B23001_073E",
             "B23001_074E",
             "B23001_075E",
             "B23001_078E",
             "B23001_079E",
             "B23001_080E",
             "B23001_083E",
             "B23001_084E",
             "B23001_085E",
             "B23001_088E",
             "B23001_090E",
             "B23001_091E",
             "B23001_093E",
             "B23001_097E",
             "B23001_098E",
             "B23001_100E",
             "B23001_104E",
             "B23001_105E",
             "B23001_107E",
             "B23001_111E",
             "B23001_112E",
             "B23001_114E",
             "B23001_118E",
             "B23001_119E",
             "B23001_121E",
             "B23001_125E",
             "B23001_126E",
             "B23001_128E",
             "B23001_132E",
             "B23001_133E",
             "B23001_135E",
             "B23001_139E",
             "B23001_140E",
             "B23001_142E",
             "B23001_146E",
             "B23001_147E",
             "B23001_149E",
             "B23001_153E",
             "B23001_154E",
             "B23001_156E",
             "B23001_159E",
             "B23001_160E",
             "B23001_161E",
             "B23001_164E",
             "B23001_165E",
             "B23001_166E",
             "B23001_169E",
             "B23001_170E",
             "B23001_171E",
             "B24042_001E",
             "B24042_028E",
             "B24080_001E",
             "B24080_003E",
             "B24080_006E",
             "B24080_007E",
             "B24080_008E",
             "B24080_009E",
             "B24080_010E",
             "B24080_011E",
             "B24080_013E",
             "B24080_016E",
             "B24080_017E",
             "B24080_018E",
             "B24080_019E",
             "B24080_020E",
             "B24080_021E",
             "B25014_001E",
             "B25014_003E",
             "B25014_004E",
             "B25014_005E",
             "B25014_006E",
             "B25014_007E",
             "B25014_009E",
             "B25014_010E",
             "B25014_011E",
             "B25014_012E",
             "B25014_013E",
             "B25016_007E",
             "B25016_016E",
             "B25017_001E",
             "B25017_002E",
             "B25017_003E",
             "B25017_004E",
             "B25017_005E",
             "B25017_006E",
             "B25017_007E",
             "B25017_008E",
             "B25017_009E",
             "B25017_010E",
             "B25018_001E",
             "B25024_001E",
             "B25024_002E",
             "B25024_003E",
             "B25024_004E",
             "B25024_005E",
             "B25024_006E",
             "B25024_007E",
             "B25024_008E",
             "B25024_009E",
             "B25024_010E",
             "B25024_011E",
             "B25034_001E",
             "B25034_002E",
             "B25034_004E",
             "B25034_005E",
             "B25034_006E",
             "B25034_007E",
             "B25034_008E",
             "B25034_009E",
             "B25034_010E",
             "B25034_011E",
             "B25038_001E",
             "B25038_003E",
             "B25038_004E",
             "B25038_005E",
             "B25038_006E",
             "B25038_007E",
             "B25038_008E",
             "B25038_010E",
             "B25038_011E",
             "B25038_012E",
             "B25038_013E",
             "B25038_014E",
             "B25038_015E",
             "B25040_001E",
             "B25040_002E",
             "B25040_003E",
             "B25040_004E",
             "B25040_005E",
             "B25040_006E",
             "B25040_007E",
             "B25040_008E",
             "B25040_009E",
             "B25040_010E",
             "B25043_007E",
             "B25043_016E",
             "B25044_001E",
             "B25044_003E",
             "B25044_004E",
             "B25044_005E",
             "B25044_006E",
             "B25044_007E",
             "B25044_008E",
             "B25044_010E",
             "B25044_011E",
             "B25044_012E",
             "B25044_013E",
             "B25044_014E",
             "B25044_015E",
             "B25052_003E",
             "B25063_001E",
             "B25063_002E",
             "B25063_003E",
             "B25063_004E",
             "B25063_005E",
             "B25063_006E",
             "B25063_007E",
             "B25063_008E",
             "B25063_009E",
             "B25063_010E",
             "B25063_011E",
             "B25063_012E",
             "B25063_013E",
             "B25063_014E",
             "B25063_015E",
             "B25063_016E",
             "B25063_017E",
             "B25063_018E",
             "B25063_019E",
             "B25063_020E",
             "B25063_021E",
             "B25063_022E",
             "B25063_023E",
             "B25063_024E",
             "B25063_025E",
             "B25063_026E",
             "B25063_027E",
             "B25064_001E",
             "B25070_001E",
             "B25070_002E",
             "B25070_003E",
             "B25070_004E",
             "B25070_005E",
             "B25070_006E",
             "B25070_007E",
             "B25070_008E",
             "B25070_009E",
             "B25070_010E",
             "B25070_011E",
             "B25075_001E",
             "B25075_002E",
             "B25075_003E",
             "B25075_004E",
             "B25075_005E",
             "B25075_006E",
             "B25075_007E",
             "B25075_008E",
             "B25075_009E",
             "B25075_010E",
             "B25075_011E",
             "B25075_012E",
             "B25075_013E",
             "B25075_014E",
             "B25075_015E",
             "B25075_016E",
             "B25075_017E",
             "B25075_018E",
             "B25075_019E",
             "B25075_020E",
             "B25075_021E",
             "B25075_022E",
             "B25075_023E",
             "B25075_024E",
             "B25075_025E",
             "B25075_026E",
             "B25075_027E",
             "B25077_001E",
             "B25087_001E",
             "B25087_002E",
             "B25087_003E",
             "B25087_004E",
             "B25087_005E",
             "B25087_006E",
             "B25087_007E",
             "B25087_008E",
             "B25087_009E",
             "B25087_010E",
             "B25087_011E",
             "B25087_012E",
             "B25087_013E",
             "B25087_014E",
             "B25087_015E",
             "B25087_016E",
             "B25087_017E",
             "B25087_018E",
             "B25087_019E",
             "B25087_020E",
             "B25093_001E",
             "B25093_003E",
             "B25093_004E",
             "B25093_005E",
             "B25093_006E",
             "B25093_007E",
             "B25093_008E",
             "B25093_010E",
             "B25093_011E",
             "B25093_012E",
             "B25093_013E",
             "B25093_014E",
             "B25093_015E",
             "B25093_017E",
             "B25093_018E",
             "B25093_019E",
             "B25093_020E",
             "B25093_021E",
             "B25093_022E",
             "B25093_024E",
             "B25093_025E",
             "B25093_026E",
             "B25093_027E",
             "B25093_028E",
             "B25093_029E",
             "C16001_001E",
             "C16001_002E",
             "C16001_003E",
             "C16001_005E",
             "C16001_006E",
             "C16001_008E",
             "C16001_009E",
             "C16001_011E",
             "C16001_012E",
             "C16001_014E",
             "C16001_015E",
             "C16001_017E",
             "C16001_018E",
             "C16001_020E",
             "C16001_021E",
             "C16001_023E",
             "C16001_024E",
             "C16001_026E",
             "C16001_027E",
             "C16001_029E",
             "C16001_030E",
             "C16001_032E",
             "C16001_033E",
             "C16001_035E",
             "C16001_036E",
             "C16001_038E",
             "C24010_001E",
             "C24010_003E",
             "C24010_019E",
             "C24010_027E",
             "C24010_031E",
             "C24010_032E",
             "C24010_033E",
             "C24010_034E",
             "C24010_039E",
             "C24010_055E",
             "C24010_063E",
             "C24010_067E",
             "C24010_068E",
             "C24010_069E",
             "C24010_070E",
             "C24030_001E",
             "C24030_003E",
             "C24030_006E",
             "C24030_007E",
             "C24030_008E",
             "C24030_009E",
             "C24030_010E",
             "C24030_013E",
             "C24030_014E",
             "C24030_017E",
             "C24030_021E",
             "C24030_024E",
             "C24030_027E",
             "C24030_028E",
             "C24030_030E",
             "C24030_033E",
             "C24030_034E",
             "C24030_035E",
             "C24030_036E",
             "C24030_037E",
             "C24030_040E",
             "C24030_041E",
             "C24030_044E",
             "C24030_048E",
             "C24030_051E",
             "C24030_054E",
             "C24030_055E",
             "B25034_003E")

#=================================================================
#1, United Sate Population

pop21_us <- get_acs(geography = "us",
                    variables = all_var,
                    year = 2021,
                    #state = "us",
                    #county = "Allegheny",
                    output =  "wide",          # this is to put the value in column
                    moe_level = 95)
#==============================================================

#2. Pennsylvania

pop21_PA <- get_acs(geography = "state",
                    variables =  all_var,
                    year = 2021,
                    state = "PA",
                    #county = "Allegheny",
                    output =  "wide", 
                    moe_level = 95)

# =============================================================
#3. SPC Region

pop21_SPC_Co <- get_acs(geography = "county",
                        variables =  all_var,
                        year = 2021,
                        state = "PA",
                        county = c("Allegheny","Armstrong","Beaver",
                                   "Butler","Fayette","Greene", "Indiana",
                                   "Lawrence", "Washington", "Westmoreland"),
                        output =  "wide",
                        moe_level = 95)


#===============================================================

#4. SPC Region Municipality

pop21_SPC_Muni <- get_acs(geography = "county subdivision",
                          variables =  all_var,
                          year = 2021,
                          state = "PA",
                          county = c("Allegheny","Armstrong","Beaver",
                                     "Butler","Fayette","Greene", "Indiana",
                                     "Lawrence", "Washington", "Westmoreland"),
                          output =  "wide",
                          moe_level = 95)


#===============================================================

#5. Pittsburgh Metropolitan area 
# edit this 

pop21_PGH_pop<- get_acs(geography = "msa",
                        variables =  all_var,
                        year = 2021,
                        region = "Metropolitan statistical area/metropolitan stattistical area:*", in = "state:42"

                        #CBSA = 38300,  # Pittsburgh Code is
                        #state = "PA",
                        #county = c("Allegheny","Armstrong","Beaver",
                        #          "Butler","Fayette","Greene", "Indiana",
                        #          "Lawrence", "Washington", "Westmoreland"),
                        output =  "wide",
                        moe_level = 95)

#================================================================
#5. Pittsburgh Metropolitan area 
# edit this 
pop21_msa_pop <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
                        variables =  all_var,
                        year = 2021,
                        region = "Pittsburgh, PA",                        
                        output =  "wide",
                        moe_level = 95)

# Extract Pittsburgh metropolitan area using GEOID = 38300
pop21_PGH_pop <- subset(pop21_msa_pop,pop21_msa_pop$GEOID == "38300")

#========================================================

# Put all together

data_all <- rbind(pop21_us,pop21_PA,pop21_PGH_pop, pop21_SPC_Co, pop21_SPC_Muni)

# because data all has the Estimate and marginal errors, we need the estimates only, hence

# get the first two column 
GEOId_Name <- data_all[ ,c(1,2)]
data <- data_all[ , -c(1,2)]

#Remove column that have M in the column name

# Method1 
data_e <- data
data_e[ ,grep("M", colnames(data))] <- NULL

#Replace all the "E" with Blank

colnames(data_e) <- gsub('E', '', colnames(data_e))
data_all_F2 <- cbind (GEOId_Name, data_e)

#======================================================
# Method 2

# https://stackoverflow.com/questions/69960690/how-to-write-an-apply-function-that-only-applies-to-odd-numbered-columns-in-r
# 
# odd <- !seq(ncol(data)) %% 2 == 0 # gets the odd column list
# data_oddCol <- data[, odd] <- apply(data[, odd], 2, function(x) {return(x + 1)}) # Extract the data frames odd  columns
# data_oddCol_df <- as.data.frame(data_oddCol)   # convert the data matrix form into data frame
# 
# # Remove "E" from the column names
# colnames(data_oddCol_df) <- gsub('E', '', colnames(data_oddCol_df))
# 
# data_all_F <- cbind (GEoId_Name, data_oddCol_df)

#======================================================

# Get the SPC region counties and ccreate the sum  for 42SPC

SPCReg <- subset(data_all_F2, data_all_F2$GEOID %in% c(42003, 42005, 42007, 42019, 42051, 42059, 42063, 42073, 42125, 42129))

#==================
library(dplyr)

# create total
SPCReg_w_Total <- SPCReg %>% bind_rows(summarise(., across(where(is.numeric), sum),
                      across(where(is.character), ~'Total')))

# Add totals for SPC counties
SPCReg_w_Total$GEOID[SPCReg_w_Total$GEOID == "Total"] <- "42SPC"
SPCReg_w_Total$NAME[SPCReg_w_Total$NAME == "Total"] <- "42SPC"

SPC_Total <- subset(SPCReg_w_Total, SPCReg_w_Total$GEOID == "42SPC")
# Put all together

All_data <- rbind(SPC_Total, data_all_F2)
#To rest the index
row.names(All_data) <-NULL
#Put in order
All_data_ordered <- All_data[c(2,3,1,5:565,4), ]


# Reshaping the file to flat file
data_all_F2_Long<- reshape2::melt(All_data_ordered,id.vars = c("GEOID","NAME"))

# Save this to CSV
write.csv(All_data_ordered,"L:/Belachew/2023/ForCycle12/DataForSPC_DataCenter/Flat File/CensusDataTest/Data/ACS_2017_2021_w.csv", row.names = FALSE)
write.csv(data_all_F2_Long,"L:/Belachew/2023/ForCycle12/DataForSPC_DataCenter/Flat File/CensusDataTest/Data/ACS_2017_2021_L.csv", row.names = FALSE)
write.csv(v21,"L:/Belachew/2023/ForCycle12/DataForSPC_DataCenter/Flat File/CensusDataTest/Data/VAr_ACS_2017_2021.csv", row.names = FALSE) # Variables 
write.csv(v19,"L:/Belachew/2023/ForCycle12/DataForSPC_DataCenter/Flat File/CensusDataTest/Data/VAr_ACS_2015_2019.csv", row.names = FALSE) # Variables
